<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>products &mdash; bernutils 0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="bernutils 0.1 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">bernutils 0.1 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for products</h1><div class="highlight"><pre>
<span class="c">#! /usr/bin/python</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">ftplib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">bernutils.gpstime</span>
<span class="kn">import</span> <span class="nn">bernutils.webutils</span>

<span class="n">COD_HOST</span>  <span class="o">=</span> <span class="s">&#39;ftp.unibe.ch&#39;</span>
<span class="n">IGS_HOST</span> <span class="o">=</span> <span class="s">&#39;cddis.gsfc.nasa.gov&#39;</span>

<span class="n">COD_DIR</span>       <span class="o">=</span> <span class="s">&#39;/aiub/CODE&#39;</span>
<span class="n">COD_DIR_2013</span>  <span class="o">=</span> <span class="s">&#39;/aiub/REPRO_2013/CODE&#39;</span>
<span class="n">IGS_DIR</span>       <span class="o">=</span> <span class="s">&#39;/gnss/products&#39;</span>
<span class="n">IGS_DIR_2013</span>  <span class="o">=</span> <span class="s">&#39;/gnss/products/repro2&#39;</span>

<span class="n">erp_type</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;d&#39;</span><span class="p">:</span> <span class="s">&#39;CODwwww7.ERP.Z&#39;</span><span class="p">,</span>
        <span class="s">&#39;f&#39;</span><span class="p">:</span> <span class="s">&#39;cofwwww7.erp.Z&#39;</span><span class="p">,</span>
        <span class="s">&#39;r&#39;</span><span class="p">:</span> <span class="s">&#39;CODwwwwn.ERP_R&#39;</span><span class="p">,</span>
        <span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="s">&#39;COD.ERP_U&#39;</span><span class="p">,</span>
        <span class="s">&#39;p&#39;</span><span class="p">:</span> <span class="s">&#39;CODwwwwn.ERP_Pi&#39;</span><span class="p">,</span>
        <span class="s">&#39;2d&#39;</span><span class="p">:</span> <span class="s">&#39;CO2wwww7.ERP.Z&#39;</span><span class="p">,</span>
        <span class="s">&#39;2f&#39;</span><span class="p">:</span> <span class="s">&#39;cf2wwww7.erp.Z&#39;</span>
<span class="p">}</span>
<span class="sd">&#39;&#39;&#39; A dictionary to hold pairs of erp file types and corresponding</span>
<span class="sd">    erp file names.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">sp3_type</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;d&#39;</span><span class="p">:</span> <span class="s">&#39;CODwwwwn.EPH.Z&#39;</span><span class="p">,</span>
        <span class="s">&#39;f&#39;</span><span class="p">:</span> <span class="s">&#39;cofwwwwn.eph.Z&#39;</span><span class="p">,</span>
        <span class="s">&#39;r&#39;</span><span class="p">:</span> <span class="s">&#39;CODwwwwn.EPH_R&#39;</span><span class="p">,</span>
        <span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="s">&#39;COD.EPH_U&#39;</span><span class="p">,</span>
        <span class="s">&#39;p&#39;</span><span class="p">:</span> <span class="s">&#39;CODwwwwn.EPH_Pi&#39;</span><span class="p">,</span>
        <span class="s">&#39;2d&#39;</span><span class="p">:</span> <span class="s">&#39;CO2wwwwn.EPH.Z&#39;</span><span class="p">,</span>
        <span class="s">&#39;2f&#39;</span><span class="p">:</span> <span class="s">&#39;cf2wwwwn.eph.Z&#39;</span>
<span class="p">}</span>
<span class="sd">&#39;&#39;&#39; A dictionary to hold pairs of sp3 file types and corresponding</span>
<span class="sd">    sp3 file names.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">dcb_type</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;p2&#39;</span><span class="p">:</span> <span class="s">&#39;P1P2yymm.DCB&#39;</span><span class="p">,</span>
            <span class="s">&#39;c1&#39;</span><span class="p">:</span> <span class="s">&#39;P1C1yymm.DCB&#39;</span><span class="p">,</span>
            <span class="s">&#39;c1_rnx&#39;</span><span class="p">:</span> <span class="s">&#39;P1C1yymm_RINEX.DCB&#39;</span><span class="p">,</span>
            <span class="s">&#39;c2_rnx&#39;</span><span class="p">:</span> <span class="s">&#39;P2C2yymm_RINEX.DCB&#39;</span>
<span class="p">}</span>
<span class="sd">&#39;&#39;&#39; A dictionary to hold pairs of dcb file types and corresponding</span>
<span class="sd">    dcb file names.</span>
<span class="sd">&#39;&#39;&#39;</span>

<div class="viewcode-block" id="_getRunningDcb_"><a class="viewcode-back" href="../products.html#products._getRunningDcb_">[docs]</a><span class="k">def</span> <span class="nf">_getRunningDcb_</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">saveas</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Utility function to assist :py:func:`getCodDcb`; do *NOT* use as standalone.</span>
<span class="sd">        This function is used within the :py:func:`getCodDcb` to download a running</span>
<span class="sd">        dcb file from CODE.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">HOST</span> <span class="o">=</span> <span class="n">COD_HOST</span>
    <span class="n">dirn</span> <span class="o">=</span> <span class="n">COD_DIR</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">bernutils</span><span class="o">.</span><span class="n">webutils</span><span class="o">.</span><span class="n">grabFtpFile</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span><span class="n">dirn</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">saveas</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span>
</div>
<div class="viewcode-block" id="_getFinalDcb_"><a class="viewcode-back" href="../products.html#products._getFinalDcb_">[docs]</a><span class="k">def</span> <span class="nf">_getFinalDcb_</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">saveas</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Utility function to assist :py:func:`getCodDcb`; do *NOT* use as standalone.</span>
<span class="sd">        This function is used within the :py:func:`getCodDcb` to download a final</span>
<span class="sd">        dcb file from CODE.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">HOST</span> <span class="o">=</span> <span class="n">COD_HOST</span>
    <span class="n">dirn</span> <span class="o">=</span> <span class="n">COD_DIR</span> <span class="o">+</span> <span class="p">(</span><span class="s">&#39;/</span><span class="si">%04i</span><span class="s">/&#39;</span><span class="o">%</span><span class="n">year</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">bernutils</span><span class="o">.</span><span class="n">webutils</span><span class="o">.</span><span class="n">grabFtpFile</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span><span class="n">dirn</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">saveas</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span>
</div>
<div class="viewcode-block" id="getCodDcb"><a class="viewcode-back" href="../products.html#products.getCodDcb">[docs]</a><span class="k">def</span> <span class="nf">getCodDcb</span><span class="p">(</span><span class="n">stype</span><span class="p">,</span><span class="n">datetm</span><span class="p">,</span><span class="n">out_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Download .DCB file from CODE&#39;s ftp webserver.</span>

<span class="sd">        :param stype: Can be one of:</span>

<span class="sd">            * ``&#39;p2&#39;`` for P1P2 dcb, or</span>
<span class="sd">            * ``&#39;c1&#39;`` for P1C1 dcb, or</span>
<span class="sd">            * ``&#39;c1_rnx&#39;`` for P1C1_RINEX dcb, or</span>
<span class="sd">            * ``&#39;c2_rnx&#39;`` for P1C2_RINEX dcb</span>

<span class="sd">            The ``stype`` parameter is matched to a corresponding file, using the :py:data:`dcb_type` dictionary.</span>

<span class="sd">        :param datetm: A python ``datetime`` object.</span>
<span class="sd">        :param out_dir: Path to directory where the downloaded file shall</span>
<span class="sd">                        be stored.</span>

<span class="sd">        Depending on the input date (i.e. ``datetm``), one of the following will</span>
<span class="sd">        happen:</span>

<span class="sd">            * if today and ``datetm`` are the same year and same month, the the running dcb file will be downloaded,</span>
<span class="sd">            * if deltadays between today and ``datetm`` is less than 30 days, then the final dcb file will first be checked. If it is not available, then the running dcb will be downloaded isntead,</span>
<span class="sd">            * if deltadays between today and ``datetm`` is 30 or more, then the final dcb file file will be downloaded.</span>

<span class="sd">        .. note::</span>
<span class="sd">            Available Code Differential Bias files from CODE:</span>

<span class="sd">            * P1P2yymm.DCB</span>
<span class="sd">                            GNSS monthly P1-P2 code bias</span>
<span class="sd">                            solutions in Bernese DCB format</span>
<span class="sd">            * P1C1yymm.DCB/F</span>
<span class="sd">                            GPS monthly P1-C1 code bias solutions</span>
<span class="sd">                            in Bernese DCB format and in a format</span>
<span class="sd">                            specific to the CC2NONCC utility</span>
<span class="sd">            * P1C1yymm_RINEX.DCB/F</span>
<span class="sd">                            GNSS monthly P1-C1 code bias</span>
<span class="sd">                            values in Bernese DCB format and in</span>
<span class="sd">                            a format specific to the CC2NONCC</span>
<span class="sd">                            utility directly extracted from</span>
<span class="sd">                            RINEX observation files</span>
<span class="sd">            * P2C2yymm_RINEX.DCB</span>
<span class="sd">                            GNSS monthly P2-C2 code bias</span>
<span class="sd">                            values in Bernese DCB format directly</span>
<span class="sd">                            extracted from RINEX observation files</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c">## output dir must exist</span>
    <span class="k">if</span> <span class="n">out_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Invalid directory: &#39;</span><span class="o">+</span><span class="n">out_dir</span><span class="o">+</span><span class="s">&#39; -&gt; getCodDcb.&#39;</span><span class="p">)</span>

    <span class="c">## Only interested in the date part of datetm</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">datetm</span><span class="p">)</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span>
        <span class="n">datetm</span> <span class="o">=</span> <span class="n">datetm</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">generic_file</span> <span class="o">=</span> <span class="n">dcb_type</span><span class="p">[</span><span class="n">stype</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Invalid dcb type: &#39;</span><span class="o">+</span><span class="n">stype</span><span class="p">)</span>

    <span class="c"># if the current month is the same as the month requested, then</span>
    <span class="c"># download the running average.</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">dt</span>    <span class="o">=</span> <span class="n">today</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetm</span> <span class="c">##.date()</span>
    <span class="n">iyear</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetm</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y&#39;</span><span class="p">))</span>
    <span class="n">iyr2</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetm</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%y&#39;</span><span class="p">))</span>
    <span class="n">imonth</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetm</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%m&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">today</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">datetm</span><span class="o">.</span><span class="n">year</span> <span class="ow">and</span> <span class="n">today</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">datetm</span><span class="o">.</span><span class="n">month</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">generic_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;yymm&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">saveas</span>   <span class="o">=</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="n">out_dir</span><span class="p">:</span>
            <span class="n">saveas</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">localfile</span><span class="p">,</span> <span class="n">webfile</span> <span class="o">=</span> <span class="n">_getRunningDcb_</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">saveas</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">localfile</span><span class="p">,</span> <span class="n">webfile</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span>
    <span class="k">elif</span> <span class="n">dt</span><span class="o">.</span><span class="n">days</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
        <span class="c">## try for final; if fail, try for running</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">generic_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;yy&#39;</span><span class="p">,(</span><span class="s">&#39;</span><span class="si">%02i</span><span class="s">&#39;</span><span class="o">%</span><span class="n">iyr2</span><span class="p">))</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;mm&#39;</span><span class="p">,(</span><span class="s">&#39;</span><span class="si">%02i</span><span class="s">&#39;</span><span class="o">%</span><span class="n">imonth</span><span class="p">))</span>
        <span class="n">filename</span><span class="o">+=</span> <span class="s">&#39;.Z&#39;</span>
        <span class="n">saveas</span>   <span class="o">=</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="n">out_dir</span><span class="p">:</span>
            <span class="n">saveas</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">localfile</span><span class="p">,</span> <span class="n">webfile</span> <span class="o">=</span> <span class="n">_getFinalDcb_</span><span class="p">(</span><span class="n">iyear</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">saveas</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">localfile</span><span class="p">,</span> <span class="n">webfile</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">generic_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;yymm&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">saveas</span>   <span class="o">=</span> <span class="n">filename</span>
            <span class="k">if</span> <span class="n">out_dir</span><span class="p">:</span>
                <span class="n">saveas</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">localfile</span><span class="p">,</span> <span class="n">webfile</span> <span class="o">=</span> <span class="n">_getRunningDcb_</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">saveas</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">localfile</span><span class="p">,</span> <span class="n">webfile</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span>
    <span class="k">elif</span> <span class="n">dt</span><span class="o">.</span><span class="n">days</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">generic_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;yy&#39;</span><span class="p">,(</span><span class="s">&#39;</span><span class="si">%02i</span><span class="s">&#39;</span><span class="o">%</span><span class="n">iyr2</span><span class="p">))</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;mm&#39;</span><span class="p">,(</span><span class="s">&#39;</span><span class="si">%02i</span><span class="s">&#39;</span><span class="o">%</span><span class="n">imonth</span><span class="p">))</span>
        <span class="n">filename</span><span class="o">+=</span> <span class="s">&#39;.Z&#39;</span>
        <span class="n">saveas</span>   <span class="o">=</span> <span class="n">filename</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">localfile</span><span class="p">,</span> <span class="n">webfile</span> <span class="o">=</span> <span class="n">_getFinalDcb_</span><span class="p">(</span><span class="n">iyear</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">saveas</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">localfile</span><span class="p">,</span> <span class="n">webfile</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;This date seems invalid (for dcb)&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="erpTimeSpan"><a class="viewcode-back" href="../products.html#products.erpTimeSpan">[docs]</a><span class="k">def</span> <span class="nf">erpTimeSpan</span><span class="p">(</span><span class="n">filen</span><span class="p">,</span><span class="n">as_mjd</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Given a ERP filename, this function will return the min</span>
<span class="sd">        and max dates for which the file has info. The function</span>
<span class="sd">        returns a tuple of ``[max_date, min_date]``. The format</span>
<span class="sd">        (type) of the dates in the tuple, is either MJD (if the</span>
<span class="sd">        input parameter ``as_mjd`` is ``True``) or Python ``datetime``</span>
<span class="sd">        objects (if ``as_mjd`` is ``False``).</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">fin</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filen</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Cannot open erp file: &#39;</span><span class="o">+</span><span class="n">filen</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

    <span class="n">line</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;MJD&#39;</span><span class="p">:</span>
        <span class="n">fin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Invalid erp format: &#39;</span><span class="o">+</span><span class="n">filen</span><span class="p">)</span>

    <span class="n">line</span>     <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">mjd_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dummy_it</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">line</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">line</span> <span class="ow">and</span> <span class="n">dummy_it</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">as_mjd</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span> <span class="c">## append as MJD instances</span>
            <span class="n">mjd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span> <span class="c">## append as datetime.datetime instances</span>
            <span class="n">mjd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bernutils</span><span class="o">.</span><span class="n">gpstime</span><span class="o">.</span><span class="n">mjd2pydt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="n">dummy_it</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

    <span class="n">fin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">dummy_it</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Failed reading erp: &#39;</span><span class="o">+</span><span class="n">filen</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">mjd_list</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">mjd_list</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="getCodErp"><a class="viewcode-back" href="../products.html#products.getCodErp">[docs]</a><span class="k">def</span> <span class="nf">getCodErp</span><span class="p">(</span><span class="n">stype</span><span class="p">,</span><span class="n">datetm</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">out_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">use_repro_13</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">prd</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Download CODE Erp file (i.e. CODwwwwn.ERP.Z). All erp (earth orientation</span>
<span class="sd">        parameter) files are downloaded from CODE&#39;s ftp webserver (ftp.unibe.ch),</span>
<span class="sd">        except from final, clean one-day solution (i.e. cof) which are</span>
<span class="sd">        downloaded from CDDIS (cddis.gsfc.nasa.gov) and reprocessed</span>
<span class="sd">        final, clean one-day solution (i.e. cf2) which are</span>
<span class="sd">        downloaded from CDDIS (cddis.gsfc.nasa.gov) at repro2.</span>

<span class="sd">        :param stype: A char denoting the type of erp to be</span>
<span class="sd">                     downloaded. Can be:</span>

<span class="sd">                     * &#39;d&#39; final, 3-day solution,</span>
<span class="sd">                     * &#39;f&#39; final, one-day solution</span>
<span class="sd">                     * &#39;r&#39; rapid solution,</span>
<span class="sd">                     * &#39;u&#39; ultra-rapid solution,</span>
<span class="sd">                     * &#39;p&#39; prediction</span>

<span class="sd">                     The ``stype`` parameter is matched to a corresponding file, using the :py:data:`erp_type` dictionary.</span>

<span class="sd">        :param datetm: A Python ``datetime`` object; not needed</span>
<span class="sd">                       if downloading an ultra-rapid product.</span>
<span class="sd">        :param out_dir: Output directory.</span>
<span class="sd">        :param prd:    If the user wants the predicted erp (i.e.</span>
<span class="sd">                       ``stype = &#39;p&#39;``, then the prd denotes:</span>

<span class="sd">                       * ``prd = 0`` indicates 1-day predictions (0-24 hours)</span>
<span class="sd">                       * ``prd != 0`` indicates 2-day predictions (24-48 hours)</span>

<span class="sd">        :param use_repro_13: If set to ``True``, the erp file downloaded</span>
<span class="sd">                       will be the one from the reprocessing campaign</span>
<span class="sd">                       **REPRO 2013**. For more info, see</span>
<span class="sd">                       ftp://ftp.unibe.ch/aiub/REPRO_2013/CODE_REPRO_2013.ACN.</span>
<span class="sd">                       Only available when the parameter ``stype`` is ``&#39;d&#39;``</span>
<span class="sd">                       of ``&#39;f&#39;``.</span>

<span class="sd">        :returns: In sucess, a tuple is returned; first element is the</span>
<span class="sd">                  name of the saved file, the second element is the name</span>
<span class="sd">                  of the file on web.</span>

<span class="sd">        .. note::</span>
<span class="sd">            This function is very similar to products.getCodSp3(...)</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c">## output dir must exist</span>
    <span class="k">if</span> <span class="n">out_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Invalid directory: &#39;</span><span class="o">+</span><span class="n">out_dir</span><span class="o">+</span><span class="s">&#39; -&gt; getCodErp.&#39;</span><span class="p">)</span>

    <span class="c">## if we are to use repro_2013, then the type must be</span>
    <span class="c">## either &#39;d&#39; or &#39;f&#39;; they are translated to &#39;2d&#39; or &#39;2f&#39;</span>
    <span class="c">## respectively.</span>
    <span class="k">if</span> <span class="n">use_repro_13</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">stype</span> <span class="o">!=</span> <span class="s">&#39;d&#39;</span> <span class="ow">and</span> <span class="n">stype</span> <span class="o">!=</span> <span class="s">&#39;f&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Reprocessed erp only available for type: final -&gt; getCodErp.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">use_repro_13</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="p">(</span><span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;d&#39;</span> <span class="ow">or</span> <span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;f&#39;</span><span class="p">):</span>
        <span class="n">stype</span> <span class="o">=</span> <span class="s">&#39;2&#39;</span> <span class="o">+</span> <span class="n">stype</span>

    <span class="c">## date must be specified, except for ultra-rapid</span>
    <span class="k">if</span> <span class="n">stype</span> <span class="o">!=</span> <span class="s">&#39;u&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">datetm</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Must specify date -&gt; getCodErp.&#39;</span><span class="p">)</span>
    
    <span class="c">## generic erp file name (including e.g. &#39;wwww&#39;)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">generic_filen</span> <span class="o">=</span> <span class="n">erp_type</span><span class="p">[</span><span class="n">stype</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Invalid erp type -&gt; getCodErp.&#39;</span><span class="p">)</span>

    <span class="c">## we need some dates ...</span>
    <span class="k">if</span> <span class="n">datetm</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">week</span><span class="p">,</span> <span class="n">sow</span> <span class="o">=</span> <span class="n">bernutils</span><span class="o">.</span><span class="n">gpstime</span><span class="o">.</span><span class="n">pydt2gps</span><span class="p">(</span><span class="n">datetm</span><span class="p">)</span>
            <span class="n">dow</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetm</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%w&#39;</span><span class="p">))</span>
            <span class="n">iyear</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetm</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span>

    <span class="c">## --- Ftp Server --- ##</span>
    <span class="k">if</span> <span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;f&#39;</span> <span class="ow">or</span> <span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;2f&#39;</span><span class="p">:</span>
        <span class="n">HOST</span> <span class="o">=</span> <span class="n">IGS_HOST</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">HOST</span> <span class="o">=</span> <span class="n">COD_HOST</span>

    <span class="c">## ---  Directory in ftp server --- ##</span>
    <span class="k">if</span>   <span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;f&#39;</span><span class="p">:</span>
        <span class="n">dirn</span>   <span class="o">=</span> <span class="n">IGS_DIR</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%4i</span><span class="s">/&#39;</span><span class="o">%</span><span class="n">week</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;2f&#39;</span><span class="p">:</span>
        <span class="n">dirn</span>   <span class="o">=</span> <span class="n">IGS_DIR_2013</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%4i</span><span class="s">/&#39;</span><span class="o">%</span><span class="n">week</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;d&#39;</span><span class="p">:</span>
        <span class="n">dirn</span> <span class="o">=</span> <span class="n">COD_DIR</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%04i</span><span class="s">/&#39;</span> <span class="o">%</span><span class="nb">int</span><span class="p">(</span><span class="n">iyear</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;2d&#39;</span><span class="p">:</span>
        <span class="n">dirn</span> <span class="o">=</span> <span class="n">COD_DIR_2013</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%04i</span><span class="s">/&#39;</span> <span class="o">%</span><span class="nb">int</span><span class="p">(</span><span class="n">iyear</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dirn</span> <span class="o">=</span> <span class="n">COD_DIR</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span>

    <span class="c">## --- Name of the file --- ##</span>
    <span class="n">dfile</span> <span class="o">=</span> <span class="n">generic_filen</span>
    <span class="c">## all but the ultra-rapid files, contain date</span>
    <span class="k">if</span> <span class="n">stype</span> <span class="o">!=</span> <span class="s">&#39;u&#39;</span><span class="p">:</span>
        <span class="n">dfile</span> <span class="o">=</span> <span class="n">dfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;wwww&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%4i</span><span class="s">&#39;</span><span class="o">%</span><span class="n">week</span><span class="p">)</span>
        <span class="c"># dow only set if rapid or prediction</span>
        <span class="k">if</span> <span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;r&#39;</span> <span class="ow">or</span> <span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;p&#39;</span><span class="p">:</span>
            <span class="n">dfile</span> <span class="o">=</span> <span class="n">dfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%1i</span><span class="s">&#39;</span><span class="o">%</span><span class="n">dow</span><span class="p">)</span>
    <span class="c">## in case of predicted erp, we must replace the &#39;i&#39;</span>
    <span class="k">if</span> <span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;u&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dfile</span> <span class="o">=</span> <span class="n">dfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dfile</span> <span class="o">=</span> <span class="n">dfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span><span class="s">&#39;2&#39;</span><span class="p">)</span>

    <span class="c">## --- Name of the saved file --- ##</span>
    <span class="n">saveas</span> <span class="o">=</span> <span class="n">dfile</span>
    <span class="k">if</span> <span class="n">out_dir</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">out_dir</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">out_dir</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span>
        <span class="c">#saveas = out_dir + saveas</span>
        <span class="n">saveas</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span><span class="n">saveas</span><span class="p">)</span>

    <span class="c">## --- Download --- ##</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">localfile</span><span class="p">,</span> <span class="n">webfile</span> <span class="o">=</span> <span class="n">bernutils</span><span class="o">.</span><span class="n">webutils</span><span class="o">.</span><span class="n">grabFtpFile</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span><span class="n">dirn</span><span class="p">,</span><span class="n">dfile</span><span class="p">,</span><span class="n">saveas</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span>

    <span class="k">return</span> <span class="n">localfile</span><span class="p">,</span> <span class="n">webfile</span>
</div>
<div class="viewcode-block" id="getCodSp3"><a class="viewcode-back" href="../products.html#products.getCodSp3">[docs]</a><span class="k">def</span> <span class="nf">getCodSp3</span><span class="p">(</span><span class="n">stype</span><span class="p">,</span><span class="n">datetm</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">out_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">use_repro_13</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">prd</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Download CODE Sp3 file (i.e. CODwwwwn.EPH.Z). All sp3 (orbit)</span>
<span class="sd">        files are downloaded from CODE&#39;s ftp webserver (ftp.unibe.ch),</span>
<span class="sd">        except from final, clean one-day solution (i.e. cof) which are</span>
<span class="sd">        downloaded from CDDIS (cddis.gsfc.nasa.gov) and reprocessed</span>
<span class="sd">        final, clean one-day solution (i.e. cf2) which are</span>
<span class="sd">        downloaded from CDDIS (cddis.gsfc.nasa.gov) at repro2.</span>

<span class="sd">        :param stype: A char denoting the type of orbit to be</span>
<span class="sd">                     downloaded. Can be:</span>

<span class="sd">                     * &#39;d&#39; final, 3-day solution,</span>
<span class="sd">                     * &#39;f&#39; final, one-day solution</span>
<span class="sd">                     * &#39;r&#39; rapid solution,</span>
<span class="sd">                     * &#39;u&#39; ultra-rapid solution,</span>
<span class="sd">                     * &#39;p&#39; prediction</span>

<span class="sd">                     The ``stype`` parameter is matched to a corresponding file, using the :py:data:`sp3_type` dictionary.</span>

<span class="sd">        :param datetm: A Python ``datetime`` object; not needed</span>
<span class="sd">                       if downloading an ultra-rapid product.</span>
<span class="sd">        :param out_dir: Output directory.</span>
<span class="sd">        :param prd:    If the user wants the predicted orbit (i.e.</span>
<span class="sd">                       ``stype = &#39;p&#39;``, then the prd denotes:</span>

<span class="sd">                       * ``prd = 0`` indicates 1-day predictions (0-24 hours)</span>
<span class="sd">                       * ``prd != 0`` indicates 2-day predictions (24-48 hours)</span>

<span class="sd">        :param use_repro_13: If set to ``True``, the orbit file downloaded</span>
<span class="sd">                       will be the one from the reprocessing campaign</span>
<span class="sd">                       **REPRO 2013**. For more info, see</span>
<span class="sd">                       ftp://ftp.unibe.ch/aiub/REPRO_2013/CODE_REPRO_2013.ACN.</span>
<span class="sd">                       Only available when the parameter ``stype`` is ``&#39;d&#39;``</span>
<span class="sd">                       of ``&#39;f&#39;``.</span>

<span class="sd">        :returns: In sucess, a tuple is returned; first element is the</span>
<span class="sd">                  name of the saved file, the second element is the name</span>
<span class="sd">                  of the file on web.</span>

<span class="sd">        .. note::</span>
<span class="sd">            A short list of orbit products under the /CODE directory:</span>
<span class="sd">            source ftp://ftp.unibe.ch/aiub/CODE/0000_CODE.ACN</span>

<span class="sd">                * CODwwwwn.EPH.Z</span>
<span class="sd">                                GNSS ephemeris/clock data in 7 daily</span>
<span class="sd">                                files at 15-min intervals in SP3</span>
<span class="sd">                                format, including accuracy codes</span>
<span class="sd">                                computed from a long-arc analysis</span>
<span class="sd">                                Files generated from three-day long-arc solutions.</span>

<span class="sd">                * COFwwwwn.EPH.Z</span>
<span class="sd">                                GNSS ephemeris/clock data in 7 daily</span>
<span class="sd">                                files at 15-min intervals in SP3</span>
<span class="sd">                                format, including accuracy codes</span>
<span class="sd">                                computed from a clean one-day solution.</span>
<span class="sd">                                Files generated from clean one-day solutions.</span>

<span class="sd">                *Orbit positions correspond to the estimates</span>
<span class="sd">                for the middle day of a 3-day in case of a</span>
<span class="sd">                long-arc analysis.*</span>

<span class="sd">                * CODwwwwn.EPH_R</span>
<span class="sd">                                GNSS/GPS ephemeris/clock data in at</span>
<span class="sd">                                15-min intervals in SP3 format,</span>
<span class="sd">                                including accuracy codes computed</span>
<span class="sd">                                from a long-arc analysis</span>

<span class="sd">                *Orbit positions correspond to the estimates</span>
<span class="sd">                for the last day of a 3-day long-arc analysis.*</span>

<span class="sd">                * COD.EPH_U</span>
<span class="sd">                                GNSS ephemeris/broadcast clock data</span>
<span class="sd">                                in at 15-min intervals in SP3 format,</span>
<span class="sd">                                including accuracy codes computed</span>
<span class="sd">                                from a long-arc analysis.</span>

<span class="sd">                Orbit positions correspond to the estimates</span>
<span class="sd">                for the last 24 hours of a 3-day long-arc</span>
<span class="sd">                analysis plus predictions for the following</span>
<span class="sd">                24 hours.</span>

<span class="sd">                * CODwwwwn.EPH_Pi </span>
<span class="sd">                                GNSS/GPS ephemeris/clock data at</span>
<span class="sd">                                15-min intervals in SP3 format,</span>
<span class="sd">                                including accuracy codes computed </span>
<span class="sd">                                from a long-arc analysis.</span>

<span class="sd">                &quot;P2&quot; indicates 2-day predictions (24-48 hours);</span>
<span class="sd">                &quot;P&quot; indicates 1-day predictions (0-24 hours).</span>

<span class="sd">            Products under the /REPRO_2013 directory</span>
<span class="sd">            source ftp://ftp.unibe.ch/aiub/REPRO_2013/CODE_REPRO_2013.ACN</span>

<span class="sd">                * CO2wwwwn.EPH.Z</span>
<span class="sd">                                GNSS ephemeris/clock data in 7 daily</span>
<span class="sd">                                files at 15-min intervals in SP3 </span>
<span class="sd">                                format, including accuracy codes</span>
<span class="sd">                                computed from a long-arc analysis.</span>
<span class="sd">                                Files generated from three-day long-arc solutions.</span>

<span class="sd">                * CF2wwwwn.EPH.Z</span>
<span class="sd">                                GNSS ephemeris/clock data in 7 daily</span>
<span class="sd">                                files at 15-min intervals in SP3</span>
<span class="sd">                                format, including accuracy codes</span>
<span class="sd">                                computed from a clean one-day solution.</span>
<span class="sd">                                Files generated from clean one-day solutions.</span>
<span class="sd">    &#39;&#39;&#39;</span>


    <span class="c">## output dir must exist</span>
    <span class="k">if</span> <span class="n">out_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Invalid directory: &#39;</span><span class="o">+</span><span class="n">out_dir</span><span class="o">+</span><span class="s">&#39; -&gt; getCodSp3.&#39;</span><span class="p">)</span>

    <span class="c">## if we are to use repro_2013, then the type must be</span>
    <span class="c">## either &#39;d&#39; or &#39;f&#39;; they are translated to &#39;2d&#39; or &#39;2f&#39;</span>
    <span class="c">## respectively.</span>
    <span class="k">if</span> <span class="n">use_repro_13</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">stype</span> <span class="o">!=</span> <span class="s">&#39;d&#39;</span> <span class="ow">and</span> <span class="n">stype</span> <span class="o">!=</span> <span class="s">&#39;f&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Reprocessed orbits only available for type: final -&gt; getCodSp3.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">use_repro_13</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="p">(</span><span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;d&#39;</span> <span class="ow">or</span> <span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;f&#39;</span><span class="p">):</span>
        <span class="n">stype</span> <span class="o">=</span> <span class="s">&#39;2&#39;</span> <span class="o">+</span> <span class="n">stype</span>

    <span class="c">## date must be specified, except for ultra-rapid</span>
    <span class="k">if</span> <span class="n">stype</span> <span class="o">!=</span> <span class="s">&#39;u&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">datetm</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Must specify date -&gt; getCodSp3.&#39;</span><span class="p">)</span>

    <span class="c">## generic sp3 file name (including e.g. &#39;wwww&#39;)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">generic_filen</span> <span class="o">=</span> <span class="n">sp3_type</span><span class="p">[</span><span class="n">stype</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Invalid sp3 type -&gt; getCodSp3.&#39;</span><span class="p">)</span>

    <span class="c">## we need some dates ...</span>
    <span class="k">if</span> <span class="n">datetm</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">week</span><span class="p">,</span> <span class="n">sow</span> <span class="o">=</span> <span class="n">bernutils</span><span class="o">.</span><span class="n">gpstime</span><span class="o">.</span><span class="n">pydt2gps</span><span class="p">(</span><span class="n">datetm</span><span class="p">)</span>
            <span class="n">dow</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetm</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%w&#39;</span><span class="p">))</span>
            <span class="n">iyear</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetm</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span>

    <span class="c">## --- Ftp Server --- ##</span>
    <span class="k">if</span> <span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;f&#39;</span> <span class="ow">or</span> <span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;2f&#39;</span><span class="p">:</span>
        <span class="n">HOST</span> <span class="o">=</span> <span class="n">IGS_HOST</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">HOST</span> <span class="o">=</span> <span class="n">COD_HOST</span>

    <span class="c">## ---  Directory in ftp server --- ##</span>
    <span class="k">if</span>   <span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;f&#39;</span><span class="p">:</span>
        <span class="n">dirn</span>   <span class="o">=</span> <span class="n">IGS_DIR</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%4i</span><span class="s">/&#39;</span><span class="o">%</span><span class="n">week</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;2f&#39;</span><span class="p">:</span>
        <span class="n">dirn</span>   <span class="o">=</span> <span class="n">IGS_DIR_2013</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%4i</span><span class="s">/&#39;</span><span class="o">%</span><span class="n">week</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;d&#39;</span><span class="p">:</span>
        <span class="n">dirn</span> <span class="o">=</span> <span class="n">COD_DIR</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%04i</span><span class="s">/&#39;</span> <span class="o">%</span><span class="nb">int</span><span class="p">(</span><span class="n">iyear</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;2d&#39;</span><span class="p">:</span>
        <span class="n">dirn</span> <span class="o">=</span> <span class="n">COD_DIR_2013</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%04i</span><span class="s">/&#39;</span> <span class="o">%</span><span class="nb">int</span><span class="p">(</span><span class="n">iyear</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dirn</span> <span class="o">=</span> <span class="n">COD_DIR</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span>

    <span class="c">## --- Name of the file --- ##</span>
    <span class="n">dfile</span> <span class="o">=</span> <span class="n">generic_filen</span>
    <span class="c">## all but the ultra-rapid files, contain date</span>
    <span class="k">if</span> <span class="n">stype</span> <span class="o">!=</span> <span class="s">&#39;u&#39;</span><span class="p">:</span>
        <span class="n">dfile</span> <span class="o">=</span> <span class="n">dfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;wwww&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%4i</span><span class="s">&#39;</span><span class="o">%</span><span class="n">week</span><span class="p">)</span>
        <span class="n">dfile</span> <span class="o">=</span> <span class="n">dfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%1i</span><span class="s">&#39;</span><span class="o">%</span><span class="n">dow</span><span class="p">)</span>
    <span class="c">## in case of predicted orbit, we must replace the &#39;i&#39;</span>
    <span class="k">if</span> <span class="n">stype</span> <span class="o">==</span> <span class="s">&#39;u&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dfile</span> <span class="o">=</span> <span class="n">dfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dfile</span> <span class="o">=</span> <span class="n">dfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span><span class="s">&#39;2&#39;</span><span class="p">)</span>

    <span class="c">## --- Name of the saved file --- ##</span>
    <span class="n">saveas</span> <span class="o">=</span> <span class="n">dfile</span>
    <span class="k">if</span> <span class="n">out_dir</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">out_dir</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">out_dir</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span>
        <span class="c">#saveas = out_dir + saveas</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span><span class="n">saveas</span><span class="p">)</span>

    <span class="c">## --- Download --- ##</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">localfile</span><span class="p">,</span> <span class="n">webfile</span> <span class="o">=</span> <span class="n">bernutils</span><span class="o">.</span><span class="n">webutils</span><span class="o">.</span><span class="n">grabFtpFile</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span><span class="n">dirn</span><span class="p">,</span><span class="n">dfile</span><span class="p">,</span><span class="n">saveas</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span>

    <span class="k">return</span> <span class="n">localfile</span><span class="p">,</span> <span class="n">webfile</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">bernutils 0.1 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, xp,da.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>